name: ðŸš€ Deploy to VPS

on:
  push:
    branches:
      - prod
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

env:
  APP_NAME: Promosletter
  DEPLOY_PATH: /var/www/vhosts/promosletter.com/httpdocs

jobs:
  # =============================================================================
  # DÃ©ploiement sur VPS
  # =============================================================================
  deploy:
    name: ðŸš€ Deploy to VPS
    runs-on: ubuntu-latest

    environment:
      name: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: mbstring, ctype, fileinfo, openssl, PDO, tokenizer, xml, gd, pdo_mysql, bcmath, redis, zip, intl, sodium

      - name: ðŸ“¦ Install Composer dependencies
        run: composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction

      - name: ðŸŽ¨ Install and build assets
        run: |
          npm ci --silent
          npm run build --silent
          npm prune --production --silent

      - name: ðŸ“ Create deployment archive
        run: |
          mkdir -p deployment
          rsync -av --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='tests' \
            --exclude='.env' \
            --exclude='.env.prod' \
            --exclude='.env.testing' \
            --exclude='deployment' \
            --exclude='*.log' \
            ./ deployment/
          tar -czf deployment.tar.gz deployment/

      # =============================================================================
      # Upload des fichiers sur le VPS
      # =============================================================================
      - name: ðŸ“¤ Upload deployment files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: "deployment.tar.gz"
          target: "/tmp/"
          timeout: 300s

      # =============================================================================
      # ExÃ©cution complÃ¨te du dÃ©ploiement
      # =============================================================================
      - name: ðŸš€ Execute complete deployment
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          timeout: 900s
          script: |
            set -e

            # Variables de dÃ©ploiement
            export APP_DIR="${{ env.DEPLOY_PATH }}"
            export BACKUP_DIR="/var/www/backups"
            export TIMESTAMP=$(date +%Y%m%d_%H%M%S)

            # Couleurs pour les logs
            GREEN='\033[0;32m'
            YELLOW='\033[1;33m'
            RED='\033[0;31m'
            NC='\033[0m'

            log() { echo -e "${GREEN}[INFO]${NC} $1"; }
            warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
            error() { echo -e "${RED}[ERROR]${NC} $1"; }

            log "ðŸš€ Starting direct deployment of ${{ env.APP_NAME }}..."
            log "ðŸ“ Deploy path: $APP_DIR"

            # =============================================================================
            # Sauvegarde AVANT de toucher aux fichiers
            # =============================================================================
            if [ -d "$APP_DIR" ]; then
              log "ðŸ’¾ Creating backup of current version..."
              sudo mkdir -p "$BACKUP_DIR"
              sudo cp -r "$APP_DIR" "$BACKUP_DIR/backup_$TIMESTAMP"
              log "âœ… Backup saved to: $BACKUP_DIR/backup_$TIMESTAMP"
            fi

            # =============================================================================
            # ArrÃªt temporaire des services pour Ã©viter les conflits
            # =============================================================================
            log "â¸ï¸  Temporarily stopping services..."
            if command -v supervisorctl >/dev/null 2>&1; then
              sudo supervisorctl stop ${{ env.APP_NAME }}-worker:* 2>/dev/null || true
              sudo supervisorctl stop ${{ env.APP_NAME }}-reverb 2>/dev/null || true
            fi

            # =============================================================================
            # Extraction et remplacement des fichiers
            # =============================================================================
            log "ðŸ“¦ Extracting new version..."
            if [ ! -f "/tmp/deployment.tar.gz" ]; then
              error "âŒ Deployment archive not found!"
              exit 1
            fi

            # CrÃ©er le rÃ©pertoire s'il n'existe pas
            sudo mkdir -p "$APP_DIR"

            # Sauvegarder les fichiers critiques AVANT l'extraction
            if [ -f "$APP_DIR/.env" ]; then
              cp "$APP_DIR/.env" "/tmp/.env.backup"
              log "âœ… Environment file backed up"
            fi

            if [ -d "$APP_DIR/storage" ]; then
              cp -r "$APP_DIR/storage" "/tmp/storage.backup"
              log "âœ… Storage directory backed up"
            fi

            # Extraire la nouvelle version DIRECTEMENT dans APP_DIR
            tar -xzf /tmp/deployment.tar.gz -C /tmp/
            sudo rsync -av --delete \
              --exclude='.env' \
              --exclude='storage/app' \
              --exclude='storage/logs' \
              /tmp/deployment/ "$APP_DIR/"

            rm -rf /tmp/deployment*

            # =============================================================================
            # Restaurer les fichiers persistants
            # =============================================================================
            log "ðŸ“‹ Restoring persistent files..."

            # Restaurer .env
            if [ -f "/tmp/.env.backup" ]; then
              cp "/tmp/.env.backup" "$APP_DIR/.env"
              rm "/tmp/.env.backup"
              log "âœ… Environment file restored"
            else
              cp "$APP_DIR/.env.prod" "$APP_DIR/.env"
              cd "$APP_DIR"
              php -r "echo 'APP_KEY=base64:' . base64_encode(random_bytes(32)) . PHP_EOL;" >> .env
              warn "âš ï¸ New .env created with generated APP_KEY"
            fi

            # Restaurer storage
            if [ -d "/tmp/storage.backup" ]; then
              # Fusionner les dossiers storage
              sudo cp -r /tmp/storage.backup/app "$APP_DIR/storage/" 2>/dev/null || true
              sudo cp -r /tmp/storage.backup/logs "$APP_DIR/storage/" 2>/dev/null || true
              sudo rm -rf /tmp/storage.backup
              log "âœ… Storage files restored"
            fi

            # =============================================================================
            # Configuration de l'application (DANS APP_DIR)
            # =============================================================================
            cd "$APP_DIR"
            log "ðŸ”§ Configuring Laravel application..."

            # CrÃ©er les rÃ©pertoires manquants
            sudo mkdir -p storage/framework/{cache,sessions,views}
            sudo mkdir -p storage/logs
            sudo mkdir -p storage/app/public
            sudo mkdir -p bootstrap/cache

            # Permissions
            sudo chown -R www-data:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache

            # Optimisations Laravel
            log "âš¡ Running Laravel optimizations..."
            sudo -u www-data php artisan config:clear --no-interaction
            sudo -u www-data php artisan route:clear --no-interaction
            sudo -u www-data php artisan view:clear --no-interaction
            sudo -u www-data php artisan cache:clear --no-interaction

            # Migrations
            if [ "${{ github.event.inputs.environment || 'production' }}" = "production" ]; then
              log "ðŸ—ƒï¸ Running database migrations..."
              sudo -u www-data php artisan migrate:fresh --no-interaction
            fi

            # Optimisations de production
            log "ðŸš€ Applying production optimizations..."
            sudo -u www-data php artisan config:cache --no-interaction
            sudo -u www-data php artisan route:cache --no-interaction
            sudo -u www-data php artisan view:cache --no-interaction
            sudo -u www-data php artisan event:cache --no-interaction
            sudo -u www-data php artisan storage:link --no-interaction || true

            # =============================================================================
            # RedÃ©marrage des services web
            # =============================================================================
            log "ðŸ”„ Reloading web services..."
            if sudo systemctl is-active --quiet php8.3-fpm; then
              sudo systemctl reload php8.3-fpm
            elif sudo systemctl is-active --quiet php8.2-fpm; then
              sudo systemctl reload php8.2-fpm
            fi

            if sudo systemctl is-active --quiet nginx; then
              sudo nginx -t && sudo systemctl reload nginx
            fi

            # =============================================================================
            # Configuration et redÃ©marrage des services Laravel
            # =============================================================================
            log "ðŸ“¨ Configuring and restarting Laravel services..."

            # Configuration Supervisor (avec les bons chemins)
            sudo tee /etc/supervisor/conf.d/${{ env.APP_NAME }}-worker.conf > /dev/null << SUPERVISOR_CONF
            [program:${{ env.APP_NAME }}-worker]
            process_name=%(program_name)s_%(process_num)02d
            command=php $APP_DIR/artisan queue:work --sleep=3 --tries=3 --max-time=3600 --memory=512
            directory=$APP_DIR
            user=www-data
            autostart=true
            autorestart=true
            stopasgroup=true
            killasgroup=true
            numprocs=2
            redirect_stderr=true
            stdout_logfile=$APP_DIR/storage/logs/worker.log
            stdout_logfile_maxbytes=50MB
            stdout_logfile_backups=3
            stopwaitsecs=3600
            SUPERVISOR_CONF

            sudo tee /etc/supervisor/conf.d/${{ env.APP_NAME }}-reverb.conf > /dev/null << REVERB_CONF
            [program:${{ env.APP_NAME }}-reverb]
            process_name=%(program_name)s
            command=php $APP_DIR/artisan reverb:start --host=0.0.0.0 --port=8080
            directory=$APP_DIR
            user=www-data
            autostart=true
            autorestart=true
            stopasgroup=true
            killasgroup=true
            redirect_stderr=true
            stdout_logfile=$APP_DIR/storage/logs/reverb.log
            stdout_logfile_maxbytes=50MB
            stdout_logfile_backups=3
            stderr_logfile=$APP_DIR/storage/logs/reverb_error.log
            stderr_logfile_maxbytes=50MB
            stderr_logfile_backups=3
            REVERB_CONF

            # RedÃ©marrer Supervisor
            if command -v supervisorctl >/dev/null 2>&1; then
              sudo supervisorctl reread
              sudo supervisorctl update
              sudo supervisorctl start ${{ env.APP_NAME }}-worker:*
              sudo supervisorctl start ${{ env.APP_NAME }}-reverb
              
              sleep 3
              log "ðŸ“Š Services status:"
              sudo supervisorctl status ${{ env.APP_NAME }}-worker:* ${{ env.APP_NAME }}-reverb
            fi

            # RedÃ©marrer les services Laravel
            sudo -u www-data php artisan queue:restart --no-interaction || true
            sudo -u www-data php artisan reverb:restart --no-interaction || true

            # =============================================================================
            # Nettoyage et tests
            # =============================================================================
            log "ðŸ§¹ Cleaning up old backups..."
            if [ -d "$BACKUP_DIR" ]; then
              ls -dt "$BACKUP_DIR/backup_"* 2>/dev/null | tail -n +6 | xargs sudo rm -rf 2>/dev/null || true
            fi

            log "ðŸ§ª Testing deployment..."
            if sudo -u www-data php artisan --version >/dev/null 2>&1; then
              log "âœ… Laravel application is working"
            else
              error "âŒ Laravel application test failed"
              exit 1
            fi

            # =============================================================================
            # Rapport final
            # =============================================================================
            log "ðŸŽ‰ Direct deployment completed successfully!"
            log "ðŸ“ Application path: $APP_DIR"
            log "ðŸŒ Application available at: ${{ secrets.APP_URL || 'your-domain.com' }}"
            log "ðŸ’¾ Backup saved to: $BACKUP_DIR/backup_$TIMESTAMP"
      # =============================================================================
      # Tests post-dÃ©ploiement
      # =============================================================================
      - name: ðŸ§ª Post-deployment health checks
        run: |
          echo "ðŸ¥ Running health checks..."

          # Test HTTP (si URL configurÃ©e)
          if [ -n "${{ secrets.APP_URL }}" ]; then
            echo "Testing HTTP endpoint..."
            if curl -f -s --max-time 30 "${{ secrets.APP_URL }}/health" >/dev/null 2>&1; then
              echo "âœ… HTTP health check passed"
            else
              echo "âš ï¸ HTTP health check failed - application may still be starting"
            fi
          fi

          # Test WebSocket Reverb (si possible)
          if [ -n "${{ secrets.VPS_HOST }}" ]; then
            echo "Testing WebSocket endpoint..."
            if nc -z ${{ secrets.VPS_HOST }} 8080; then
              echo "âœ… WebSocket port 8080 is open"
            else
              echo "âš ï¸ WebSocket port 8080 not accessible"
            fi
          fi

          echo "âœ… Health checks completed"

      # =============================================================================
      # Notification finale
      # =============================================================================
      - name: ðŸ“¢ Deployment notification
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application:** ${{ env.APP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ Laravel Application" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¨ Queue Workers (2 processes)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¡ Reverb WebSocket Server" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "ðŸŽ‰ **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ secrets.APP_URL }}" ]; then
              echo "ðŸ”— [Visit Application](${{ secrets.APP_URL }})" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Deployment failed!**" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ§¹ Cleanup local files
        if: always()
        run: |
          rm -f deployment.tar.gz
          rm -rf deployment/

  # =============================================================================
  # Rollback automatique en cas d'Ã©chec
  # =============================================================================
  rollback:
    name: ðŸ”„ Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure() && needs.deploy.result == 'failure'

    steps:
      - name: ðŸ”„ Execute automatic rollback
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            echo "ðŸ”„ Starting automatic rollback process..."

            BACKUP_DIR="/var/www/backups"
            APP_DIR="${{ env.DEPLOY_PATH }}"

            # Trouver le backup le plus rÃ©cent
            LATEST_BACKUP=$(ls -dt "$BACKUP_DIR"/backup_* 2>/dev/null | head -n 1)

            if [ -n "$LATEST_BACKUP" ]; then
              echo "ðŸ“¦ Rolling back to: $LATEST_BACKUP"
              sudo rm -f "$APP_DIR"
              sudo ln -sf "$LATEST_BACKUP" "$APP_DIR"
              
              # RedÃ©marrer les services
              echo "ðŸ”„ Restarting services..."
              sudo systemctl reload php8.3-fpm nginx 2>/dev/null || sudo systemctl reload php-fpm nginx
              
              # RedÃ©marrer Supervisor
              if command -v supervisorctl >/dev/null 2>&1; then
                sudo supervisorctl restart ${{ env.APP_NAME }}-worker:*
                sudo supervisorctl restart ${{ env.APP_NAME }}-reverb
              fi
              
              echo "âœ… Rollback completed successfully"
              echo "ðŸŒ Application restored to previous version"
            else
              echo "âŒ No backup found for rollback"
              exit 1
            fi

      - name: ðŸ“¢ Rollback notification
        run: |
          echo "## ðŸ”„ Automatic Rollback Executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Due to deployment failure, the application has been automatically rolled back to the previous version." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action required:** Please check the deployment logs and fix the issues before attempting another deployment." >> $GITHUB_STEP_SUMMARY
